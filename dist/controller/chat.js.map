{"version":3,"sources":["../../src/controller/chat.js"],"names":["config","db","api","post","req","res","findOne","email","body","err","user","undefined","status","json","message","login","token","newChat","from","_id","towards","chatId","parseInt","save","chatValue","$and","userId","$or","saw","notification","newNotification","description","fname","type","refId","link","findById","ownerUser","transporter","createTransport","service","auth","pass","templateString","readFileSync","mailOptions","to","subject","html","render","heading","name","byperson","console","log","sendMail","info","time","Date","now","send","find","chat","pageNumber","isNaN","page","countQuery","callback","aggregate","$match","$group","$lookup","localField","foreignField","as","doc","length","retrieveQuery","skip","sort","limit","exec","parallel","results","total_pages","Math","floor","chats"],"mappings":";;;;;;AAAA;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;kBACc,gBAAoB;AAAA,QAAjBA,MAAiB,QAAjBA,MAAiB;AAAA,QAATC,EAAS,QAATA,EAAS;;AAChC,QAAIC,MAAM,sBAAV;AACF;AACA;AACEA,QAAIC,IAAJ,CAAS,MAAT,EAAiB,UAACC,GAAD,EAAMC,GAAN,EAAc;AAC7B;AACE,uBAAKC,OAAL,CAAa,EAACC,OAAMH,IAAII,IAAJ,CAASD,KAAhB,EAAb,EAAoC,UAACE,GAAD,EAAKC,IAAL,EAAY;AAC9C,gBAAGA,QAAMC,SAAT,EAAmB;AAClBN,oBAAIO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEC,SAAS,iBAAX,EAArB;AACH,aAFE,MAEE;AACT,gCAAMR,OAAN,CAAc,EAACC,OAAMH,IAAII,IAAJ,CAASD,KAAhB,EAAd,EAAqC,UAACE,GAAD,EAAKM,KAAL,EAAa;;AAE9C,wBAAG,CAACN,GAAJ,EAAQ;;AAEJ,4BAAGM,SAAOJ,SAAV,EAAoB;AAAE;;AAElBN,gCAAIO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEC,SAAS,qBAAX,EAArB;AACH,yBAHD,MAGK;;AAED,gCAAGC,MAAMC,KAAN,IAAaZ,IAAII,IAAJ,CAASQ,KAAzB,EAAgC;AAAG;AAChC,oCAAIC,UAAQ,oBAAZ;AACDA,wCAAQC,IAAR,GAAaR,KAAKS,GAAlB;AACAF,wCAAQG,OAAR,GAAgBhB,IAAII,IAAJ,CAASY,OAAzB;;AAEAH,wCAAQI,MAAR,GAAiBC,SAASZ,KAAKS,GAAd,EAAmB,EAAnB,IAAyBG,SAASlB,IAAII,IAAJ,CAASY,OAAlB,EAA2B,EAA3B,CAAzB,GAA0DV,KAAKS,GAAL,GAAWf,IAAII,IAAJ,CAASY,OAA9E,GAAwFhB,IAAII,IAAJ,CAASY,OAAT,GAAmBV,KAAKS,GAAjI;AACAF,wCAAQH,OAAR,GAAgBV,IAAII,IAAJ,CAASM,OAAzB;AACAG,wCAAQM,IAAR,CAAa,UAACd,GAAD,EAAKe,SAAL,EAAiB;;AAE7B,wCAAG,CAACf,GAAJ,EAAQ;AACJ,+DAAaH,OAAb,CAAqB;;AAEjBmB,kDAAM,CACF,EAAEC,QAAOtB,IAAII,IAAJ,CAASY,OAAlB,EADE,EAEF,EAAEO,KAAK,CAAC,EAAEC,KAAI,CAAN,EAAD,EAAY,EAAEA,KAAI,CAAN,EAAZ,CAAP,EAFE,CAFW,EAArB,EAKO,UAACnB,GAAD,EAAKoB,YAAL,EAAoB;;AAEvB,gDAAG,CAACpB,GAAJ,EAAQ;;AAEJ,oDAAGoB,gBAAc,IAAjB,EAAsB;AAClB,wDAAIC,kBAAgB,4BAApB;AACAA,oEAAgBJ,MAAhB,GAAuBtB,IAAII,IAAJ,CAASY,OAAhC;AACAU,oEAAgBhB,OAAhB,GAAwB,qBAAxB;AACAgB,oEAAgBC,WAAhB,GAA4B,2BAAyBrB,KAAKsB,KAA1D;AACAF,oEAAgBG,IAAhB,GAAqB,CAArB;AACAH,oEAAgBI,KAAhB,GAAsBxB,KAAKS,GAA3B;AACAW,oEAAgBK,IAAhB,GAAqB,OAArB;AACAL,oEAAgBP,IAAhB;AACA,mEAAKa,QAAL,CAAehC,IAAII,IAAJ,CAASY,OAAxB,EAAiC,UAACX,GAAD,EAAK4B,SAAL,EAAiB;;AAEE,4DAAG,CAAC5B,GAAJ,EAAQ;;AAE1F;AACA,gEAAI6B,cAAc,qBAAWC,eAAX,CAA2B;AAC3CC,yEAAS,OADkC;AAE3CC,sEAAM;AACN/B,0EAAM,wBADA,EAC0B;AAChCgC,0EAAM,YAFA,CAEa;AAFb;AAFqC,6DAA3B,CAAlB;AAOF,gEAAIC,iBAAiB,aAAGC,YAAH,CAAgB,gBAAhB,EAAkC,OAAlC,CAArB;AACA,gEAAIC,cAAc;AACd3B,sEAAM,uBADQ,EACiB;AAC/B4B,oEAAIT,UAAU9B,KAFA,EAEO;AACrBwC,yEAAS,mBAHK,EAGgB;AAC9BC,sEAAM,cAAIC,MAAJ,CAAWN,cAAX,EAA0B,EAACO,SAAQ,mBAAT,EAA6BC,MAAKd,UAAUL,KAA5C,EAAkDlB,SAAQV,IAAII,IAAJ,CAASM,OAAnE,EAA2EsC,UAAS1C,KAAKsB,KAAzF,EAA1B,EAA0H,UAACvB,GAAD,EAAO;AACvI,wEAAGA,GAAH,EAAO;AACH4C,gFAAQC,GAAR,CAAY7C,GAAZ;AACH;AACA,iEAJK;;AAJQ,6DAAlB;AAWA6B,wEAAYiB,QAAZ,CAAqBV,WAArB,EAAkC,UAAUpC,GAAV,EAAe+C,IAAf,EAAqB;AACnD,oEAAG/C,GAAH,EACA4C,QAAQC,GAAR,CAAY7C,GAAZ,EADA,KAIA4C,QAAQC,GAAR,CAAYE,IAAZ;AACH,6DAND;AAOA;AACU;AAAC,qDAhCqB;AAiCH,iDA1CD,MA0CK;;AAED3B,iEAAaD,GAAb,GAAiB,CAAjB;AACAC,iEAAa4B,IAAb,GAAkBC,KAAKC,GAAL,EAAlB;AACA9B,iEAAaN,IAAb;AACH;AACJ;AAEJ,yCA3DD;;AA6DAlB,4CAAIO,MAAJ,CAAW,GAAX,EAAgBgD,IAAhB,CAAqBpC,SAArB;AACH,qCA/DD,MA+DK;AACDnB,4CAAIO,MAAJ,CAAW,GAAX,EAAgBgD,IAAhB,CAAqBnD,GAArB;AACH;AACD,iCApED;AAyED,6BAhFD,MAgFK;AACDJ,oCAAIO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEC,SAAS,gBAAX,EAArB;AAEH;AAEJ;AAEJ,qBA9FD,MA8FK;;AAEGT,4BAAIO,MAAJ,CAAW,GAAX,EAAgBgD,IAAhB,CAAqBnD,GAArB;AACH;AAER,iBArGD;AAsGK;AACQ,SA3GR;AA4GF,KA9GF;AA+GF;AACAP,QAAIC,IAAJ,CAAS,MAAT,EAAiB,UAACC,GAAD,EAAMC,GAAN,EAAc;AAC3B;AACE,uBAAKC,OAAL,CAAa,EAACC,OAAMH,IAAII,IAAJ,CAASD,KAAhB,EAAb,EAAoC,UAACE,GAAD,EAAKC,IAAL,EAAY;AAC9C,gBAAGA,QAAMC,SAAT,EAAmB;AAClBN,oBAAIO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEC,SAAS,iBAAX,EAArB;AACH,aAFE,MAEE;AACT,gCAAMR,OAAN,CAAc,EAACC,OAAMH,IAAII,IAAJ,CAASD,KAAhB,EAAd,EAAqC,UAACE,GAAD,EAAKM,KAAL,EAAa;;AAE9C,wBAAG,CAACN,GAAJ,EAAQ;;AAEJ,4BAAGM,SAAOJ,SAAV,EAAoB;AAAE;;AAElBN,gCAAIO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEC,SAAS,qBAAX,EAArB;AACH,yBAHD,MAGK;;AAED,gCAAGC,MAAMC,KAAN,IAAaZ,IAAII,IAAJ,CAASQ,KAAzB,EAAgC;AAAG;;AAEhC,oCAAIK,SAASC,SAASZ,KAAKS,GAAd,EAAmB,EAAnB,IAAyBG,SAASlB,IAAII,IAAJ,CAASkB,MAAlB,EAA0B,EAA1B,CAAzB,GAAyDhB,KAAKS,GAAL,GAAWf,IAAII,IAAJ,CAASkB,MAA7E,GAAsFtB,IAAII,IAAJ,CAASkB,MAAT,GAAkBhB,KAAKS,GAA1H;;AAEG,+CAAK0C,IAAL,CAAU,EAACxC,QAAOA,MAAR,EAAV,EAA0B,UAACZ,GAAD,EAAKqD,IAAL,EAAY;AACrC,wCAAG,CAACrD,GAAJ,EAAQ;AACJ,4CAAGqD,SAAOnD,SAAV,EAAoB;;AAEhBN,gDAAIO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAArB;AACH,yCAHD,MAGK;;AAEDR,gDAAIO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBiD,IAArB;AACH;AAEJ,qCATD,MASK;;AAEDzD,4CAAIO,MAAJ,CAAW,GAAX,EAAgBgD,IAAhB,CAAqBnD,GAArB;AACH;AAED,iCAfD;AAkBL,6BAtBD,MAsBK;AACDJ,oCAAIO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEC,SAAS,gBAAX,EAArB;AAEH;AAEJ;AAEJ,qBApCD,MAoCK;;AAEGT,4BAAIO,MAAJ,CAAW,GAAX,EAAgBgD,IAAhB,CAAqBnD,GAArB;AACH;AAER,iBA3CD;AA4CK;AACQ,SAjDR;AAkDF,KApDJ;;AAsDG;AACHP,QAAIC,IAAJ,CAAS,SAAT,EAAoB,UAACC,GAAD,EAAMC,GAAN,EAAc;AAC9B;AACE,uBAAKC,OAAL,CAAa,EAACC,OAAMH,IAAII,IAAJ,CAASD,KAAhB,EAAb,EAAoC,UAACE,GAAD,EAAKC,IAAL,EAAY;AAC9C,gBAAGA,QAAMC,SAAT,EAAmB;AAClBN,oBAAIO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEC,SAAS,iBAAX,EAArB;AACH,aAFE,MAEE;AACT,gCAAMR,OAAN,CAAc,EAACC,OAAMH,IAAII,IAAJ,CAASD,KAAhB,EAAd,EAAqC,UAACE,GAAD,EAAKM,KAAL,EAAa;;AAE9C,wBAAG,CAACN,GAAJ,EAAQ;;AAEJ,4BAAGM,SAAOJ,SAAV,EAAoB;AAAE;;AAElBN,gCAAIO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEC,SAAS,qBAAX,EAArB;AACH,yBAHD,MAGK;;AAED,gCAAGC,MAAMC,KAAN,IAAaZ,IAAII,IAAJ,CAASQ,KAAzB,EAAgC;AAAG;;;AAGhC,oCAAI+C,aAAW,CAAf;;AAEA,oCAAG,CAACC,MAAM5D,IAAII,IAAJ,CAASyD,IAAf,CAAJ,EAAyB;AACtBF,iDAAW3D,IAAII,IAAJ,CAASyD,IAApB;AACD;AACD;;;AAGA,oCAAIC,aAAa,SAAbA,UAAa,CAASC,QAAT,EAAkB;AAChC,mDAAKC,SAAL,CAAe,CAC/B;AACIC,gDAAQ;AACJ1C,iDAAK,CACD,EAAET,MAAMR,KAAKS,GAAb,EADC,EAED,EAAEC,SAAQV,KAAKS,GAAf,EAFC;AADD;AADZ,qCAD+B,EAS/B,EAACmD,QAAO,EAACnD,KAAK,SAAN,EAAiB,cAAc,EAAE,SAAS,UAAX,EAA/B,EAAuD,QAAQ,EAAE,SAAS,OAAX,EAA/D,EAAoF,WAAW,EAAE,SAAS,UAAX,EAA/F,EAAR,EAT+B,EAU/B;AACIoD,iDAAS;AACLrD,kDAAM,OADD;AAELsD,wDAAY,MAFP;AAGLC,0DAAc,KAHT;AAILC,gDAAI;AAJC;;AADb,qCAV+B,EAmB/B;AACIH,iDAAS;AACJrD,kDAAM,OADF;AAELsD,wDAAY,SAFP;AAGLC,0DAAc,KAHT;AAILC,gDAAI;AAJC;;AADb,qCAnB+B,CAAf,EA2BZ,UAASjE,GAAT,EAAckE,GAAd,EAAkB;AACA,4CAAGlE,GAAH,EAAO;AAAE0D,qDAAS1D,GAAT,EAAc,IAAd;AAAqB,yCAA9B,MACI;AACA0D,qDAAS,IAAT,EAAeQ,IAAIC,MAAnB;AACF;AACP,qCAhCD;AAiCE,iCAlCL;;AAoCF,oCAAIC,gBAAgB,SAAhBA,aAAgB,CAASV,QAAT,EAAkB;AAClC,mDAAKC,SAAL,CAAe,CAC9B;AACIC,gDAAQ;AACJ1C,iDAAK,CACD,EAAET,MAAMR,KAAKS,GAAb,EADC,EAED,EAAEC,SAAQV,KAAKS,GAAf,EAFC;AADD;AADZ,qCAD8B,EAS9B,EAACmD,QAAO,EAACnD,KAAK,SAAN,EAAiB,cAAc,EAAE,SAAS,UAAX,EAA/B,EAAuD,QAAQ,EAAE,SAAS,OAAX,EAA/D,EAAoF,WAAW,EAAE,SAAS,UAAX,EAA/F,EAAR,EAT8B,EAU9B;AACIoD,iDAAS;AACLrD,kDAAM,OADD;AAELsD,wDAAY,MAFP;AAGLC,0DAAc,KAHT;AAILC,gDAAI;AAJC;;AADb,qCAV8B,EAmB9B;AACIH,iDAAS;AACJrD,kDAAM,OADF;AAELsD,wDAAY,SAFP;AAGLC,0DAAc,KAHT;AAILC,gDAAI;AAJC;;AADb,qCAnB8B,CAAf,EA2BXI,IA3BW,CA2BN,CAACf,aAAW,CAAZ,IAAe,EA3BT,EA2BagB,IA3Bb,CA2BkB,EAACtB,MAAM,CAAC,CAAR,EA3BlB,EA2B8BuB,KA3B9B,CA2BoC,EA3BpC,EA2BwCC,IA3BxC,CA2B6C,UAASxE,GAAT,EAAckE,GAAd,EAAkB;AAC9D,4CAAGlE,GAAH,EAAO;AAAE0D,qDAAS1D,GAAT,EAAc,IAAd;AAAqB,yCAA9B,MACI;AACA0D,qDAAS,IAAT,EAAeQ,GAAf;AACF;AACP,qCAhCI;AAkCJ,iCAnCA;;AAqCA,gDAAMO,QAAN,CAAe,CAAChB,UAAD,EAAaW,aAAb,CAAf,EAA4C,UAASpE,GAAT,EAAc0E,OAAd,EAAsB;AAC9D,wCAAG1E,GAAH,EAAO;AACP;AACCJ,4CAAIO,MAAJ,CAAW,GAAX,EAAgBgD,IAAhB,CAAqBnD,GAArB;AACA,qCAHD,MAGK;AACJJ,4CAAIO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACuE,aAAYC,KAAKC,KAAL,CAAWH,QAAQ,CAAR,IAAW,EAAX,GAAc,CAAzB,CAAb,EAA2ClB,MAAMF,UAAjD,EAA6DwB,OAAOJ,QAAQ,CAAR,CAApE,EAArB;AACA;AACJ,iCAPD;AAQX;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;;AAGU,6BA1ID,MA0IK;AACD9E,oCAAIO,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEC,SAAS,gBAAX,EAArB;AAEH;AAEJ;AAEJ,qBAxJD,MAwJK;;AAEGT,4BAAIO,MAAJ,CAAW,GAAX,EAAgBgD,IAAhB,CAAqBnD,GAArB;AACH;AAER,iBA/JD;AAgKK;AACQ,SArKR;AAsKF,KAxKJ;AAyKE,WAAOP,GAAP;AACD,C","file":"chat.js","sourcesContent":["import mongoose from 'mongoose';\r\nimport { Router } from 'express';\r\nimport Login from '../model/login';\r\nimport User from '../model/user';\r\nimport Chat from '../model/chat';\r\nimport async from 'async';\r\nimport nodemailer from 'nodemailer';\r\nimport fs from 'fs';\r\nimport ejs from 'ejs';\r\nimport Notification from '../model/notification';\r\nimport bodyParser from 'body-parser';\r\nexport default({ config, db }) => {\r\n  let api = Router();\r\n//adding a category\r\n//v1/chat/add\r\n  api.post('/add', (req, res) => {\r\n    //check password or match password\r\n      User.findOne({email:req.body.email},(err,user)=>{\r\n        if(user==undefined){\r\n         res.status(400).json({ message: 'User not found!' });\r\n     }else{\r\n Login.findOne({email:req.body.email},(err,login)=>{\r\n \r\n     if(!err){\r\n \r\n         if(login==undefined){ //user not found\r\n \r\n             res.status(400).json({ message: 'User not Logged In!' });\r\n         }else{\r\n \r\n             if(login.token==req.body.token ){  //token matching and only admin can add\r\n                let newChat=new Chat();\r\n               newChat.from=user._id;\r\n               newChat.towards=req.body.towards;\r\n             \r\n               newChat.chatId = parseInt(user._id, 16) > parseInt(req.body.towards, 16) ? user._id + req.body.towards : req.body.towards + user._id;\r\n               newChat.message=req.body.message;\r\n               newChat.save((err,chatValue)=>{\r\n\r\n                if(!err){\r\n                    Notification.findOne({\r\n                        \r\n                        $and: [\r\n                            { userId:req.body.towards },\r\n                            { $or: [{ saw:1 }, { saw:0 }] }\r\n                        ]},(err,notification)=>{\r\n\r\n                        if(!err){\r\n\r\n                            if(notification==null){\r\n                                let newNotification=new Notification();\r\n                                newNotification.userId=req.body.towards;\r\n                                newNotification.message=\"You have a message!\"\r\n                                newNotification.description=\"Message recieved from \"+user.fname;\r\n                                newNotification.type=6;\r\n                                newNotification.refId=user._id;\r\n                                newNotification.link=\"/chat\";\r\n                                newNotification.save();\r\n                                User.findById((req.body.towards),(err,ownerUser)=>{\r\n                                    \r\n                                                                                    if(!err){\r\n                                                                                    \r\n  //sending mail \r\n  var transporter = nodemailer.createTransport({\r\n    service: 'Gmail',\r\n    auth: {\r\n    user: 'toshikverma1@gmail.com', // Your email id\r\n    pass: '123123123a' // Your password\r\n    }\r\n});\r\nvar templateString = fs.readFileSync('views/chat.ejs', 'utf-8');\r\nvar mailOptions = {\r\n    from: 'toshikverma@gmail.com', // sender address\r\n    to: ownerUser.email, // list of receivers\r\n    subject: 'Message Recieved!', // Subject line\r\n    html: ejs.render(templateString,{heading:\"Message Recieved!\",name:ownerUser.fname,message:req.body.message,byperson:user.fname},(err)=>{\r\n    if(err){\r\n        console.log(err);\r\n    }\r\n    }) \r\n    \r\n};\r\ntransporter.sendMail(mailOptions, function (err, info) {\r\n    if(err)\r\n    console.log(err)\r\n    \r\n    else\r\n    console.log(info);\r\n});\r\n//sending mail ends\r\n         }});\r\n                            }else{\r\n                                \r\n                                notification.saw=0;\r\n                                notification.time=Date.now();\r\n                                notification.save();\r\n                            }\r\n                        }\r\n\r\n                    });\r\n                   \r\n                    res.status(200).send(chatValue);\r\n                }else{\r\n                    res.status(500).send(err);\r\n                }\r\n               });\r\n                    \r\n                    \r\n \r\n \r\n             }else{\r\n                 res.status(400).json({ message: 'invalid token!' });\r\n \r\n             }\r\n       \r\n         }\r\n        \r\n     }else{\r\n \r\n             res.status(400).send(err);\r\n         }\r\n   \r\n });\r\n     }\r\n             });\r\n   });\r\n//v1/chat/get\r\napi.post('/get', (req, res) => {\r\n    //check password or match password\r\n      User.findOne({email:req.body.email},(err,user)=>{\r\n        if(user==undefined){\r\n         res.status(400).json({ message: 'User not found!' });\r\n     }else{\r\n Login.findOne({email:req.body.email},(err,login)=>{\r\n \r\n     if(!err){\r\n \r\n         if(login==undefined){ //user not found\r\n \r\n             res.status(400).json({ message: 'User not Logged In!' });\r\n         }else{\r\n \r\n             if(login.token==req.body.token ){  //token matching and only admin can add\r\n                \r\n                let chatId = parseInt(user._id, 16) > parseInt(req.body.userId, 16) ? user._id + req.body.userId : req.body.userId + user._id;\r\n                    \r\n                   Chat.find({chatId:chatId},(err,chat)=>{\r\n                    if(!err){\r\n                        if(chat===undefined){\r\n\r\n                            res.status(200).json({});\r\n                        }else{\r\n\r\n                            res.status(200).json(chat);\r\n                        }\r\n\r\n                    }else{\r\n\r\n                        res.status(500).send(err);\r\n                    }\r\n\r\n                   }); \r\n \r\n \r\n             }else{\r\n                 res.status(400).json({ message: 'invalid token!' });\r\n \r\n             }\r\n       \r\n         }\r\n        \r\n     }else{\r\n \r\n             res.status(400).send(err);\r\n         }\r\n   \r\n });\r\n     }\r\n             });\r\n   });\r\n\r\n   //v1/chat/get\r\napi.post('/getAll', (req, res) => {\r\n    //check password or match password\r\n      User.findOne({email:req.body.email},(err,user)=>{\r\n        if(user==undefined){\r\n         res.status(400).json({ message: 'User not found!' });\r\n     }else{\r\n Login.findOne({email:req.body.email},(err,login)=>{\r\n \r\n     if(!err){\r\n \r\n         if(login==undefined){ //user not found\r\n \r\n             res.status(400).json({ message: 'User not Logged In!' });\r\n         }else{\r\n \r\n             if(login.token==req.body.token ){  //token matching and only admin can add\r\n                \r\n               \r\n                let pageNumber=1\r\n        \r\n                if(!isNaN(req.body.page)){\r\n                   pageNumber=req.body.page;\r\n                 }\r\n                 //async query start here\r\n                 \r\n                 \r\n                 var countQuery = function(callback){\r\n                    Chat.aggregate([\r\n    { \r\n        $match: { \r\n            $or: [\r\n                { from: user._id }, \r\n                { towards:user._id }\r\n            ]                   \r\n        } \r\n    },\r\n    {$group:{_id: '$chatId', \"otherField\": { \"$last\": \"$message\" },\"from\": { \"$last\": \"$from\" },\"towards\": { \"$last\": \"$towards\" }}},\r\n    { \r\n        $lookup: { \r\n            from: \"users\", \r\n            localField: \"from\", \r\n            foreignField: \"_id\", \r\n            as: \"fromName\" \r\n        }\r\n        \r\n    },\r\n    { \r\n        $lookup: { \r\n             from: \"users\", \r\n            localField: \"towards\", \r\n            foreignField: \"_id\", \r\n            as: \"towardsName\" \r\n        }\r\n        \r\n    }], function(err, doc){\r\n                          if(err){ callback(err, null) }\r\n                          else{\r\n                              callback(null, doc.length);\r\n                           }\r\n                    }\r\n                    )};\r\n            \r\n               var retrieveQuery = function(callback){\r\n                   Chat.aggregate([\r\n    { \r\n        $match: { \r\n            $or: [\r\n                { from: user._id }, \r\n                { towards:user._id }\r\n            ]                   \r\n        } \r\n    },\r\n    {$group:{_id: '$chatId', \"otherField\": { \"$last\": \"$message\" },\"from\": { \"$last\": \"$from\" },\"towards\": { \"$last\": \"$towards\" }}},\r\n    { \r\n        $lookup: { \r\n            from: \"users\", \r\n            localField: \"from\", \r\n            foreignField: \"_id\", \r\n            as: \"fromName\" \r\n        }\r\n        \r\n    },\r\n    { \r\n        $lookup: { \r\n             from: \"users\", \r\n            localField: \"towards\", \r\n            foreignField: \"_id\", \r\n            as: \"towardsName\" \r\n        }\r\n        \r\n    }]).skip((pageNumber-1)*12).sort({time: -1}).limit(12).exec(function(err, doc){\r\n                    if(err){ callback(err, null) }\r\n                    else{\r\n                        callback(null, doc);\r\n                     }\r\n              });\r\n                   \r\n              };\r\n            \r\n               async.parallel([countQuery, retrieveQuery], function(err, results){\r\n                   if(err){\r\n                   // console.log(\"error here\");\r\n                    res.status(500).send(err);\r\n                   }else{\r\n                    res.status(200).json({total_pages:Math.floor(results[0]/12+1) , page: pageNumber, chats: results[1]});\r\n                   }\r\n               });\r\n    //                Chat.aggregate([\r\n    // { \r\n    //     $match: { \r\n    //         $or: [\r\n    //             { from: user._id }, \r\n    //             { towards:user._id }\r\n    //         ]                   \r\n    //     } \r\n    // },\r\n    // {$group:{_id: '$chatId', \"otherField\": { \"$last\": \"$message\" },\"from\": { \"$last\": \"$from\" },\"towards\": { \"$last\": \"$towards\" }}},\r\n    // { \r\n    //     $lookup: { \r\n    //         from: \"users\", \r\n    //         localField: \"from\", \r\n    //         foreignField: \"_id\", \r\n    //         as: \"fromName\" \r\n    //     }\r\n        \r\n    // },\r\n    // { \r\n    //     $lookup: { \r\n    //          from: \"users\", \r\n    //         localField: \"towards\", \r\n    //         foreignField: \"_id\", \r\n    //         as: \"towardsName\" \r\n    //     }\r\n        \r\n    // }],\r\n    // (err,chat)=>{\r\n    //                 if(!err){\r\n    //                     if(chat===undefined){\r\n\r\n    //                         res.status(200).json({});\r\n    //                     }else{\r\n\r\n    //                         res.status(200).json(chat);\r\n    //                     }\r\n\r\n    //                 }else{\r\n\r\n    //                     res.status(500).send(err);\r\n    //                 }\r\n\r\n    //                }); \r\n \r\n \r\n             }else{\r\n                 res.status(400).json({ message: 'invalid token!' });\r\n \r\n             }\r\n       \r\n         }\r\n        \r\n     }else{\r\n \r\n             res.status(400).send(err);\r\n         }\r\n   \r\n });\r\n     }\r\n             });\r\n   });\r\n  return api;\r\n}\r\n"]}